{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>{{ title }}</h2>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center" id="filterAnalysisHeader">
                    Filtrowanie analizy
                    <button class="btn btn-link btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filterAnalysisBody" aria-expanded="false" aria-controls="filterAnalysisBody">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
                <div class="card-body collapse" id="filterAnalysisBody">
                    <form method="GET" action="{{ url_for('tenders.unit_prices_analysis') }}">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="work_type" class="form-label">Nazwa roboty</label>
                                <select class="form-control select2-enable" id="filter_work_type" name="work_type">
                                    <option value="">-- Wybierz --</option>
                                    {% for wt in work_types %}
                                    <option value="{{ wt.id }}" {% if selected_work_type == wt.id %}selected{% endif %}>{{ wt.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="category" class="form-label">Kategoria</label>
                                <select class="form-control select2-enable" id="filter_category" name="category">
                                    <option value="">-- Wybierz --</option>
                                    {% for cat in categories %}
                                    <option value="{{ cat.id }}" {% if selected_category == cat.id %}selected{% endif %}>{{ cat.nazwa_kategorii }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="tender" class="form-label">Oferta</label>
                                <select class="form-control select2-enable" id="filter_tender" name="tender">
                                    <option value="">-- Wybierz --</option>
                                    {% for tender_item in tenders %}
                                    <option value="{{ tender_item.id }}" {% if selected_tender == tender_item.id %}selected{% endif %}>{{ tender_item.nazwa_oferty }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="firmy" class="form-label">Wykonawca</label>
                                <select class="form-control select2-enable" id="filter_firmy" name="firmy">
                                    <option value="">-- Wybierz --</option>
                                    {% for firma in firmy %}
                                    <option value="{{ firma.id_firmy }}" {% if selected_firmy == firma.id_firmy %}selected{% endif %}>{{ firma.nazwa_firmy }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="project" class="form-label">Projekt</label>
                                <select class="form-control select2-enable" id="filter_project" name="project">
                                    <option value="">-- Wybierz --</option>
                                    {% for project_item in projects %}
                                    <option value="{{ project_item.id }}" {% if selected_project == project_item.id %}selected{% endif %}>{{ project_item.nazwa_projektu }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-12 mb-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">Filtruj</button>
                                <a href="{{ url_for('tenders.unit_prices_analysis') }}" class="btn btn-secondary">Resetuj</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center" id="analysisTypeHeader">
                    Wybierz typ analizy
                    <button class="btn btn-link btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#analysisTypeBody" aria-expanded="false" aria-controls="analysisTypeBody">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
                <div class="card-body collapse" id="analysisTypeBody">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="analysis_type" class="form-label">Typ analizy</label>
                            <select class="form-control select2-enable" id="analysis_type">
                                <option value="">-- Wybierz typ analizy --</option>
                                <option value="time_series">Średnia cena w czasie</option>
                                <option value="by_contractor">Porównanie cen wykonawców</option>
                            </select>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="analysis_work_type" class="form-label">Nazwa roboty (dla analizy)</label>
                            <select class="form-control select2-enable" id="analysis_work_type">
                                <option value="">-- Wybierz nazwę roboty --</option>
                                {% for wt in work_types %}
                                <option value="{{ wt.id }}">{{ wt.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                        <div class="col-md-12 mt-3">
                            <button type="button" class="btn btn-primary" id="generate_chart_btn">Generuj wykres</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3" id="analysis_chart_container" style="display: none;">
        <div class="card-header">
            Wyniki analizy
        </div>
        <div class="card-body" style="height: 400px;">
            <canvas id="analysisChart"></canvas>
        </div>
    </div>

    {% if analysis_results %}
    <div class="table-responsive">
        <table class="table table-striped table-hover table-responsive-stacking">
            <thead>
                <tr>
                    <th>Nazwa roboty</th>
                    <th>Min. Cena</th>
                    <th>Max. Cena</th>
                    <th>Średnia Cena</th>
                    <th>Liczba pozycji</th>
                </tr>
            </thead>
            <tbody>
                {% for result in analysis_results %}
                <tr>
                    <td data-label="Nazwa roboty">{{ result[0] }}</td>
                    <td data-label="Min. Cena">{{ "%.2f"|format(result[1]) }}</td>
                    <td data-label="Max. Cena">{{ "%.2f"|format(result[2]) }}</td>
                    <td data-label="Średnia Cena">{{ "%.2f"|format(result[3]) }}</td>
                    <td data-label="Liczba pozycji">{{ result[4] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>Brak danych do analizy.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    $(document).ready(function() {
        $('.select2-enable').select2({
            placeholder: "-- Wybierz --",
            allowClear: true // Allow clearing selection for filters
        });

        let analysisChart; // Zmienna do przechowywania instancji wykresu

        $('#generate_chart_btn').on('click', function() {
            const analysisType = $('#analysis_type').val();
            const workTypeId = $('#analysis_work_type').val();

            if (analysisType && workTypeId) {
                let url = '';
                let chartLabel = '';
                let chartType = '';

                if (analysisType === 'time_series') {
                    url = `{{ url_for('tenders.unit_prices_time_series_data', work_type_id=0) }}`.replace('0', workTypeId);
                    chartLabel = 'Średnia cena w czasie';
                    chartType = 'line';
                } else if (analysisType === 'by_contractor') {
                    url = `{{ url_for('tenders.unit_prices_by_contractor_data', work_type_id=0) }}`.replace('0', workTypeId);
                    chartLabel = 'Średnia cena wg wykonawcy';
                    chartType = 'bar';
                }

                $.getJSON(url, function(data) {
                    $('#analysis_chart_container').show();
                    if (analysisChart) {
                        analysisChart.destroy(); // Zniszcz poprzedni wykres
                    }
                    const ctx = document.getElementById('analysisChart').getContext('2d');
                    analysisChart = new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: chartLabel,
                                data: data.data,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                fill: false // Dla wykresów liniowych
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Cena'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Kryterium'
                                    }
                                }
                            }
                        }
                    });
                });
            } else {
                $('#analysis_chart_container').hide();
                if (analysisChart) {
                    analysisChart.destroy();
                }
                alert('Proszę wybrać typ analizy i nazwę roboty.');
            }
        });
    });
</script>
{% endblock %}
